(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,72393,e=>{"use strict";let t=(0,e.i(15315).default)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);e.s(["Send",()=>t],72393)},49493,e=>{"use strict";let t=(0,e.i(15315).default)("inbox",[["polyline",{points:"22 12 16 12 14 15 10 15 8 12 2 12",key:"o97t9d"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}]]);e.s(["Inbox",()=>t],49493)},13818,e=>{"use strict";var t=e.i(73942),s=e.i(28787),a=e.i(8013),r=e.i(84680),l=e.i(72393);let n=(0,e.i(15315).default)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var i=e.i(69553),d=e.i(49493),c=e.i(74898),o=e.i(38854),m=e.i(20797);function u(){let e=(0,a.createClient)(),[u,x]=(0,s.useState)(""),[h,g]=(0,s.useState)([]),[f,p]=(0,s.useState)(!0),[b,_]=(0,s.useState)(null),[v,j]=(0,s.useState)(null),[y,N]=(0,s.useState)([]),[w,S]=(0,s.useState)(!1),[q,k]=(0,s.useState)(""),[T,C]=(0,s.useState)(!1),D=(0,s.useRef)(null),$=(0,s.useRef)(null),{toast:F}=(0,m.useToast)(),M=(0,s.useCallback)(()=>{D.current?.scrollIntoView({behavior:"smooth"})},[]);async function L(){let{data:{user:t}}=await e.auth.getUser();if(!t)return;x(t.id);let{data:s,error:a}=await e.from("engagement_requests").select("id, user_id, target_id").eq("status","accepted").or(`user_id.eq.${t.id},target_id.eq.${t.id}`);if(a){console.error("Failed to load conversations:",a.message),_("Failed to load conversations. Please refresh the page."),p(!1);return}if(!s||0===s.length){g([]),p(!1);return}let r=[];for(let a of s){let s=a.user_id===t.id?a.target_id:a.user_id,[l,n,i]=await Promise.all([e.from("profiles").select("display_name, trust_score, trust_level, avatar_url").eq("id",s).single(),e.from("messages").select("content, created_at").eq("conversation_id",a.id).order("created_at",{ascending:!1}).limit(1),e.from("messages").select("id",{count:"exact",head:!0}).eq("conversation_id",a.id).eq("receiver_id",t.id).eq("read",!1)]),d=n.data?.[0];r.push({id:a.id,other_user_id:s,profile:l.data||{display_name:"Unknown User",trust_score:0,trust_level:"new",avatar_url:null},last_message:d?.content||null,last_message_at:d?.created_at||null,unread_count:i.count||0})}r.sort((e,t)=>e.last_message_at&&t.last_message_at?new Date(t.last_message_at).getTime()-new Date(e.last_message_at).getTime():e.last_message_at?-1:t.last_message_at?1:t.unread_count-e.unread_count),g(r),p(!1)}async function U(t){j(t),S(!0),N([]),k("");let{data:s,error:a}=await e.from("messages").select("*").eq("conversation_id",t.id).order("created_at",{ascending:!0});a&&(console.error("Failed to load messages:",a.message),_("Failed to load messages.")),N(s||[]),S(!1),t.unread_count>0&&(await e.from("messages").update({read:!0}).eq("conversation_id",t.id).eq("receiver_id",u).eq("read",!1),g(e=>e.map(e=>e.id===t.id?{...e,unread_count:0}:e))),$.current&&e.removeChannel($.current),$.current=e.channel(`messages:${t.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${t.id}`},s=>{let a=s.new;N(e=>e.some(e=>e.id===a.id)?e:[...e,a]),a.receiver_id===u&&e.from("messages").update({read:!0}).eq("id",a.id).then(),g(e=>e.map(e=>e.id===t.id?{...e,last_message:a.content,last_message_at:a.created_at}:e))}).subscribe()}async function A(){if(!q.trim()||!v||T)return;let t=q.trim();k(""),C(!0);let{error:s}=await e.from("messages").insert({conversation_id:v.id,sender_id:u,receiver_id:v.other_user_id,content:t});s&&(console.error("Failed to send message:",s.message),_("Failed to send message. Please try again."),F("Failed to send message","error"),k(t)),C(!1)}return((0,s.useEffect)(()=>{L()},[]),(0,s.useEffect)(()=>()=>{$.current&&e.removeChannel($.current)},[]),(0,s.useEffect)(()=>{M()},[y,M]),v)?(0,t.jsxs)("div",{className:"flex flex-col h-[calc(100vh-2rem)]",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3 pb-4 border-b border-border mb-4",children:[(0,t.jsx)("button",{onClick:()=>{j(null),$.current&&(e.removeChannel($.current),$.current=null)},className:"p-2 hover:bg-bg-elevated rounded-lg transition-colors",children:(0,t.jsx)(n,{className:"w-5 h-5 text-text-muted"})}),(0,t.jsx)("div",{className:"w-10 h-10 rounded-xl bg-bg-elevated flex items-center justify-center overflow-hidden",children:v.profile.avatar_url?(0,t.jsx)("img",{src:v.profile.avatar_url,alt:"",className:"w-full h-full object-cover"}):(0,t.jsx)("span",{className:"text-sm font-bold text-text-muted",children:v.profile.display_name.charAt(0).toUpperCase()})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"font-semibold text-sm",children:v.profile.display_name}),(0,t.jsxs)("div",{className:"flex items-center gap-1 text-xs text-text-muted",children:[(0,t.jsx)(c.Shield,{className:"w-3 h-3"}),"Trust: ",v.profile.trust_score,(0,t.jsx)("span",{className:`ml-1 px-1.5 py-0.5 rounded-full text-[10px] ${"trusted"===v.profile.trust_level||"exemplary"===v.profile.trust_level?"bg-success/10 text-success":"bg-bg-elevated text-text-muted"}`,children:v.profile.trust_level})]})]})]}),b&&(0,t.jsx)("div",{className:"mb-4 p-3 bg-danger/10 border border-danger/30 rounded-xl text-sm text-danger",children:b}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto space-y-3 pr-2",children:w?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(i.Loader2,{className:"w-8 h-8 text-accent animate-spin"})}):0===y.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[(0,t.jsx)(r.MessageSquare,{className:"w-12 h-12 text-text-muted mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Start the conversation"}),(0,t.jsxs)("p",{className:"text-text-muted text-sm max-w-sm",children:["You're matched with ",v.profile.display_name,". Send a message to begin your introduction."]})]}):(0,t.jsxs)(t.Fragment,{children:[y.map(e=>{let s=e.sender_id===u;return(0,t.jsx)("div",{className:`flex ${s?"justify-end":"justify-start"}`,children:(0,t.jsxs)("div",{className:`max-w-[75%] px-4 py-2.5 rounded-2xl text-sm ${s?"bg-accent text-white rounded-br-md":"bg-bg-card border border-border text-text rounded-bl-md"}`,children:[(0,t.jsx)("p",{className:"whitespace-pre-wrap break-words",children:e.content}),(0,t.jsxs)("p",{className:`text-[10px] mt-1 ${s?"text-white/60":"text-text-muted"}`,children:[new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),s&&e.read&&" â€¢ Read"]})]})},e.id)}),(0,t.jsx)("div",{ref:D})]})}),(0,t.jsx)("div",{className:"pt-4 border-t border-border mt-4",children:(0,t.jsxs)("form",{onSubmit:e=>{e.preventDefault(),A()},className:"flex items-end gap-2",children:[(0,t.jsx)("textarea",{value:q,onChange:e=>k(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),A())},placeholder:"Type a message...",rows:1,className:"flex-1 bg-bg-card border border-border rounded-xl px-4 py-3 text-text text-sm resize-none focus:outline-none focus:border-accent max-h-32",style:{minHeight:"44px"}}),(0,t.jsx)("button",{type:"submit",disabled:!q.trim()||T,className:"bg-accent hover:bg-accent-bright text-white p-3 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:T?(0,t.jsx)(i.Loader2,{className:"w-5 h-5 animate-spin"}):(0,t.jsx)(l.Send,{className:"w-5 h-5"})})]})})]}):(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold mb-1",children:"Messages"}),(0,t.jsx)("p",{className:"text-text-muted mb-8",children:"Secure conversations with your accepted matches. End-to-end privacy by design."}),b&&(0,t.jsx)("div",{className:"mb-4 p-3 bg-danger/10 border border-danger/30 rounded-xl text-sm text-danger",children:b}),f?(0,t.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,t.jsx)(i.Loader2,{className:"w-8 h-8 text-accent animate-spin"})}):0===h.length?(0,t.jsxs)("div",{className:"bg-bg-card border border-border rounded-2xl p-12 text-center",children:[(0,t.jsx)(d.Inbox,{className:"w-16 h-16 text-text-muted mx-auto mb-4"}),(0,t.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"No conversations yet"}),(0,t.jsx)("p",{className:"text-text-muted text-sm mb-6 max-w-md mx-auto",children:"Once you accept a match (or someone accepts yours), you can start messaging here. All conversations require mutual opt-in."}),(0,t.jsxs)(o.default,{href:"/matches",className:"inline-flex items-center gap-2 bg-accent hover:bg-accent-bright text-white px-5 py-2.5 rounded-xl text-sm font-medium transition-colors",children:[(0,t.jsx)(r.MessageSquare,{className:"w-4 h-4"}),"View Matches"]})]}):(0,t.jsx)("div",{className:"space-y-2",children:h.map(e=>{let s,a;return(0,t.jsx)("button",{onClick:()=>U(e),className:"w-full bg-bg-card border border-border rounded-2xl p-4 hover:border-border-bright transition-colors text-left",children:(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-xl bg-bg-elevated flex items-center justify-center overflow-hidden shrink-0",children:e.profile.avatar_url?(0,t.jsx)("img",{src:e.profile.avatar_url,alt:"",className:"w-full h-full object-cover"}):(0,t.jsx)("span",{className:"text-sm font-bold text-text-muted",children:e.profile.display_name.charAt(0).toUpperCase()})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("h3",{className:`font-semibold text-sm truncate ${(e.unread_count,"text-text")}`,children:e.profile.display_name}),e.last_message_at&&(0,t.jsx)("span",{className:"text-[11px] text-text-muted shrink-0 ml-2",children:(s=new Date(e.last_message_at),0===(a=Math.floor((new Date().getTime()-s.getTime())/864e5))?s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):1===a?"Yesterday":a<7?s.toLocaleDateString([],{weekday:"short"}):s.toLocaleDateString([],{month:"short",day:"numeric"}))})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("p",{className:`text-sm truncate ${e.unread_count>0?"text-text font-medium":"text-text-muted"}`,children:e.last_message||"No messages yet"}),e.unread_count>0&&(0,t.jsx)("span",{className:"bg-accent text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shrink-0 ml-2",children:e.unread_count})]})]})]})},e.id)})})]})}e.s(["default",()=>u],13818)}]);